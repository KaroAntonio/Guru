<!doctype html>
<meta charset="utf-8">
<html>
<head>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<link rel="stylesheet" type="text/css" href="style.css">
<script type="text/javascript">
    
var properties_data,
    properties,
    filtered,
    selected,
    selectedID,
    content,
    table,
    init = false,
    loaded = false;
    
var filters = [],
    attributes = [],
    filter_cells = [],
    favourites = [],
    showFiltered = false;
    
if (is_cookie('favourites'))
    favourites = JSON.parse(get_cookie('favourites'))
importJson();  

var attr_keys = {
    'ID':'id',
    'State':'state',
    'City':'city',
    'Bedrooms':'bedrooms',
    'Sale Status':'sale_status',
    'Address':'address',
    'Price':'price',
    'Rent Zestimate':'rent_zestimate',
    'Zestimate':'zestimate',
    'Lot Size':'lot_size',
    'Bathrooms':'bathrooms',
    'Square Feet':'sqrft',
    'Notes':'notes',
    'Rental Valuation':'rental_valuation',
    
}

/*
var titles = [
    ['ID','id'],
    ['State','state'],
    ['City','city'],
    //['Address', 'address'],
    //['Valuation','rental_valuation'],
    //['Estimated Rent','rent_zestimate'],
    //['Sale Price','price'],
    ['Bedrooms','bedrooms'],
    ['Sale Status','sale_status'],
]
*/

var titles = [
    'ID',
    'State',
    'City',
    'Sale Status',
]

//Import Json
function importJson() {
    console.log("Import")
    
    d3.json("properties.json", function (data) {
        properties = data;
        
        if (!init) {
            init = true;
            document.getElementById('min_price').value = 0;
            document.getElementById('max_price').value = 1000000;
            //Set the headers for both tables
            
            
        }
        initFilters();
        updateTables();
        drawFilters();
    })
}

function initFilters() {
    var title_row = $('#table-titles').empty();
    attributes = []
    filters = []
    for (i = 0; i < titles.length; i++) {
        attributes.push([]);
        //filters[titles[i]] = [];
        filters.push([]);
        title_row.append($('<td></td>').text(titles[i]));
    }
}
    
function drawFilters() {
    //Populate Select Menus
    $("#addColumn").empty();
    $("#removeColumn").empty();
    var addCol = document.getElementById("addColumn");
    var attrs = Object.keys(attr_keys)
    addCol[addCol.length] = new Option('Add Column', null);
    for (var i = 0; i < attrs.length; ++i) {
        if (titles.indexOf(attrs[i]) == -1)
            addCol[addCol.length] = new Option(attrs[i], attrs[i]);
    }
    
    var removeCol = document.getElementById("removeColumn");
    removeCol[removeCol.length] = new Option('Remove Column', null);
    for (var i = 0; i < titles.length; ++i) {
        removeCol[removeCol.length] = new Option(titles[i], titles[i]);
        
    }
    
    var title_row = $('#table-titles');
    //console.log(titles);
    var filter_rows = [
        $('#table-static-header-row-add-filters').empty(),
        $('#table-static-header-row-remove-filters').empty(),
    ]
    
    //Add in filters
    for (var i = 0; i < title_row.children().length; i++){
        
        for (j = 0; j < filter_rows.length; j++) {
            
            filter_rows[j].append($('<td></td>'));
            
            var cell = filter_rows[j].children()[i];
            var select = document.createElement("select");
                select.id = "select-" + j.toString() + i.toString();
            
            cell.appendChild(select);
            
            //Blank Cell
            var option = document.createElement("option");
            option.value = "";
            if (j == 0)
                option.text = "Filter " + titles[i];
            else 
                option.text = "Clear Filter";
            select.appendChild(option);
            
            //Fill Add / Clear Filter Selects
            if (j == 0){
                
                //Sort Attibutes for the dropdowns
                if (isNaN(attributes[i][0])) {
                    //As String
                    attributes[i].sort();
                } else {
                    //As Number
                    attributes[i].sort(function (a,b) {
                        return (Number(a) - Number(b));
                    });
                }
                for (k = 0; k < attributes[i].length; k++) {
                    if (filters[i].indexOf(attributes[i][k]) == -1) {
                    //if (filters[titles[i]].indexOf(attributes[i][k]) == -1) {
                        var option = document.createElement("option");
                        option.value = attributes[i][k];
                        option.text = attributes[i][k];
                        select.appendChild(option);
                    }
                }
                
                //DRAW Filter Toggle
                /*
                var toggle = document.createElement("button");
                if (!toggled[i]) 
                    toggle.innerHTML = "O";
                else
                    toggle.innerHTML = "X";
                toggle.id = "toggle-" + i.toString();
                cell.appendChild(toggle);
                
                toggle.onclick = function (e) {
                    var i = Number(this.id[this.id.length - 1]);
                    if (toggled[i]) {
                        toggled[i] = false;
                    } else {
                        toggled[i] = true;
                    }
                    updateTables();
                    drawFilters();
                }
                */
                
                
            } else {
                filters[i].sort();
                for (k = 0; k < filters[i].length; k++) {
                    
                    var option = document.createElement("option");
                    option.value = filters[i][k];
                    option.text = filters[i][k];
                    select.appendChild(option);
                }
            }
            
            select.onchange = function (e) {
                var s = this.options[this.selectedIndex].value;
                var ii = Number(this.id[this.id.length - 1]);
                var jj = Number(this.id[this.id.length - 2]);
                var ie = filters[ii].indexOf(s);
                if (ie == -1) {
                    if (jj == 0)
                        filters[ii].push(s)
                    else
                        filters[ii].splice(ie, 1);
                } else {
                    if (jj != 0)
                        filters[ii].splice(ie, 1);
                }
                updateTables();
                drawFilters();
                
            }
        }
    }
}
    
function updateTables() {
    
    //Filter and Sort properties
    var min_price = Number(document.getElementById('min_price').value);
    var max_price = Number(document.getElementById('max_price').value);
    
    if (properties != null) {
        properties = properties.filter(function (el) {
          return el.price >= min_price &&
                    el.price <= max_price;
        });
        
        properties.sort(function(a, b){
            var precedence;
            if (b.rent_zestimate == -1) precedence = -10000;
            else (a.price/a.rent_zestimate)-(b.price/b.rent_zestimate)
            return precedence;
        });
    }
    
    /*
    if (properties != null)
            document.getElementById('table_info').innerHTML = "Ranked:" + properties.length
            */
    populateTables();
}   

function populateTables() {
    $("#table-rows-table tr").remove();
    if (properties != null) {
        properties.forEach(function(d) {
            addRow("table-rows-table", d)
        })
    }
}

//Add Row
function addRow(tableID, b, rowCount) {
    table = document.getElementById(tableID);
    if (rowCount = null)
        rowCount = table.rows.length;
    var row = table.insertRow(rowCount);
    
    //FILTER
    var filtered;
    if (showFiltered) filtered = true;
    else filtered = false;
    for (i = 0; i < filters.length; i++) {
        if (showFiltered) {
            if (filters[i].indexOf(b[attr_keys[titles[i]]]) != -1)
                filtered = false;
        } else {
            if (filters[i].indexOf(b[attr_keys[titles[i]]]) != -1)
                filtered = true;
        }
    }
    
    if (filtered) return;
    
    if (favourites.indexOf(b.id) != -1)
        row.classList.toggle('favourite')
        
    if (selectedID == b.id)
        selectRow(tableID, row, b)
    
    if (b == null)
        row.insertCell(0).innerHTML= "Nothing to Receive";
    else {
        for (i = 0; i < titles.length; i++) {
            if (attributes[i].indexOf(b[attr_keys[titles[i]]]) == -1)
                attributes[i].push(b[attr_keys[titles[i]]]);
            row.insertCell(i).innerHTML = b[attr_keys[titles[i]]];
        }
    }
    row.classList.toggle('row')
    
    //Make row selectable
    row.onclick = function () { selectRow(tableID, row, b) }
    return;
}
    
function selectRow(tableID, row, b) {
    //DESELECT last selected Row
    if (selected != null) {
        selected.classList.toggle('selected');
        //selected.style.display = 'table-row'
        content.parentNode.removeChild(content);
        selected.classList.toggle('top')
    }
    
    selectedID = b.id
    selected = row
    selected.classList.toggle('selected')
    //selected.style.display = 'none'
    
    var newRow = table.insertRow(row.rowIndex + 1)
    content = newRow.insertCell(0);
    content.classList.toggle('content');
    //newRow.classList.toggle('top')
    newRow.classList.toggle('bottom')
    newRow.classList.toggle('selected')
    selected.classList.toggle('top')
    if (row.classList.contains('favourite')) 
        content.classList.toggle('favourite');
    
    var toggle = document.createElement('div')
    toggle.className = "fav-toggle"
    if (favourites.indexOf(b.id) == -1) {
        toggle.innerHTML = "&#9734"
    } else {
        toggle.innerHTML = "&#9733"
    }
    toggle.onclick = function() { toggleFav(toggle, row, content, b) }
    content.appendChild(toggle)
    
    /*
    var title = document.createElement('div')
    title.innerHTML = "Home Data"
    title.className = "row-title"
    content.appendChild(title)
    */
    
    var link = document.createElement('div')
    link.className = "zillow-link"
    link.innerHTML = "View Home"
    link.onclick = function() { window.open(b.zillow_url); }
    content.appendChild(link)
    
    var desc = document.createElement('div')
    desc.innerHTML = b.address + ", " + b.city + ", " + b.state
    desc.className = "row-desc"
    content.appendChild(desc)
    
    $( "#home-data" ).empty();
    for (var property in b) {
        if (b.hasOwnProperty(property)) {
            var data = document.createElement('div')
            data.className = "data"
            data.innerHTML = property + ": " + b[property]
            //content.appendChild(data)
            if (b[property] != null)
                document.getElementById('home-data').appendChild(data)
        }
    }
    
    content.colSpan = titles.length;

    //window.open(b.zillow_url);
    //updateTables()
}
    
function toggleFav(toggle, row, content, b) {
    content.classList.toggle('favourite');
    row.classList.toggle('favourite');
    if (favourites.indexOf(b.id) == -1) {
        favourites.push(b.id)
        toggle.innerHTML = "&#9733"
    } else {
        toggle.innerHTML = "&#9734"
        favourites.splice(favourites.indexOf(b.id,1))
    }
    set_cookie('favourites',JSON.stringify(favourites),365)
    
}
    
function toggleFilters() {
    var toggle = document.getElementById("toggle_button");
    console.log("Toggle")
    if (showFiltered) {
        toggle.value = "Show Filtered";
        showFiltered = false;
    } else {
        toggle.value = "Hide Filtered";
        showFiltered = true;
    }
    
    updateTables();
    drawFilters();
}
    
function set_cookie ( cookie_name, cookie_value, lifespan_in_days, valid_domain ) {
    // http://www.thesitewizard.com/javascripts/cookies.shtml
    var domain_string = valid_domain ? ("; domain=" + valid_domain) : '' ;
    document.cookie = cookie_name + "=" + encodeURIComponent( cookie_value ) +
      "; max-age=" + 60 * 60 * 24 * lifespan_in_days +
      "; path=/" + domain_string ;
}
    
function is_cookie(cookie_name) {
    var cookie_string = document.cookie ;
    if (cookie_string.length != 0) {
        var cookie_value = cookie_string.match ( cookie_name + '=([^;]*)' );
        return cookie_value != null;
    }
    return false;
}
    
function get_cookie ( cookie_name )
{
    // http://www.thesitewizard.com/javascripts/cookies.shtml
    var cookie_string = document.cookie ;
    if (cookie_string.length != 0) {
        var cookie_value = cookie_string.match ( cookie_name + '=([^;]*)' );
        return decodeURIComponent ( cookie_value[1] ) ;
    }
    return '' ;
}
    
function clearFavourites() {
    favourites = []
    set_cookie('favourites',JSON.stringify(favourites),365)
    updateTables()
}
    
function reset() {
    if (showFiltered)
        toggleFilters()
    
    initFilters();
    updateTables();
    drawFilters();
}
    
function showFavourites() {
    //Show Only Favourites
    //Add ID Filter
    if (titles.indexOf('ID') == -1)
        titles.push('ID')
        
    //Show Filtered
    if (!showFiltered)
        toggleFilters()
        
    initFilters();
    for (i = 0; i < favourites.length; i++)
        filters[titles.indexOf('ID')].push(favourites[i])
    updateTables();
    drawFilters();
}
    
function addColumn() {
    //Find Column to Add
    var m = document.getElementById("addColumn");
    var new_col = typeof new_col !== 'undefined' ?  new_col : m.options[m.selectedIndex].value;
    if (new_col == null) return
    
    //Add Column to table
    titles.push(new_col)
    initFilters();
    updateTables();
    drawFilters();
}
    
function removeColumn() {
    //Find Column to Remove
    var m = document.getElementById("removeColumn");
    var col = typeof col !== 'undefined' ?  col : m.options[m.selectedIndex].value;
    if (col == null) return
    
    //Remove Column from table
    titles.splice(titles.indexOf(col), 1);
    initFilters();
    updateTables();
    drawFilters();
}

</script>
<title>REI Guru</title>
</head>
<body>
<div class="title"></div>
<div id="message"></div>
<div id="propertiesTable">
	<div class="tableTitle">REI Guru</div>
    <!--<div id="table_info"> Ranked </div>-->
    <div class="search_prefs">
    Minimum Price: 
    <input id="min_price" type="text" name="min_price">
    <br>
    Maximum Price: 
    <input id="max_price" type="text" name="max_price">
    </div>
    <br>
    <!--<input type="button" value="Update Properties" id="import_button" onclick="importJson()"/>-->
    <input type="button" value="Reset" id="reset_button" onclick="reset()"/>
    <input type="button" value="Show Filtered" id="toggle_button" onclick="toggleFilters()"/>
    <input type="button" value="Clear Favourites" id="clear_button" onclick="clearFavourites()"/>
    <input type="button" value="Show Favourites" id="faves_button" onclick="showFavourites()"/>
    <!--<input type="button" value="Add Column" id="col_button" onclick="addColumn()"/>-->
    <select id='addColumn' onchange='addColumn()'></select>
    <select id='removeColumn' onchange='removeColumn()'></select>
     	     <div class="table-wrapper">
                <table class="table-static-header">
                    <thead>
                        <tr id="table-titles" class="table-static-header-row">
                        </tr>
                        <tr id="table-static-header-row-add-filters" class="table-static-header-row">
                        </tr>
                        <tr id="table-static-header-row-remove-filters" class="table-static-header-row">
                        </tr>
                        
                    </thead>
                </table>
                <div class="table-rows-table-wrapper">
                    <table id="table-rows-table">
                        <tbody>	</tbody>
                    </table>
                </div>
            </div>
     </div>
    <div id="home-data">
    </div>
</body>
</html>


<script>  
  
</script>