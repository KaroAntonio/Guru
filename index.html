<!doctype html>
<meta charset="utf-8">
<html>
<head>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<link rel="stylesheet" type="text/css" href="style.css">
<script type="text/javascript">
    
var properties_data,
    properties,
    filtered,
    selected,
    init = false,
    loaded = false;
    
var filters = [];
    
var attributes = [];

importJson();  
    
var titles = [
    ['State','state'],
    ['City','city'],
    ['Estimated Rent','rent_zestimate'],
    ['Sale Price','price'],
    ['Bedrooms','bedrooms'],
    ['Sale Status','sale_status'],
]

//Import Json
function importJson() {
    console.log("Import")
    
    d3.json("properties.json", function (data) {
        properties = data;
        
        if (!init) {
            init = true;
            document.getElementById('min_price').value = 0;
            document.getElementById('max_price').value = 1000000;
            //Set the headers for both tables
            var title_row = $('#table-titles').empty();
            
            for (i = 0; i < titles.length; i++) {
                attributes.push([]);
                filters.push([]);
                title_row.append($('<td></td>').text(titles[i][0]));
            }
        }
        updateTables();
        drawFilters();
    })
}
    
function drawFilters() {
    
    console.log(attributes[0]);
    
    var title_row = $('#table-titles');
    //console.log(titles);
    var filter_rows = [
        $('#table-static-header-row-add-filters').empty(),
        $('#table-static-header-row-remove-filters').empty(),
    ]
    
    //Add in filters
    for (var i = 0; i < title_row.children().length; i++){
        for (j = 0; j < filter_rows.length; j++) {
            
            filter_rows[j].append($('<td></td>'));
            var cell = filter_rows[j].children()[i];
            var select = document.createElement("select");
                select.id = "select-" + j.toString() + i.toString();
            
            cell.appendChild(select);
            
            //Blank Cell
            var option = document.createElement("option");
            option.value = "";
            if (j == 0)
                option.text = "Filter " + titles[i][0];
            else 
                option.text = "Clear Filter";
            select.appendChild(option);
            
            //Fill Add Selects
            if (j == 0){
                for (k = 0; k < attributes[i].length; k++) {
                    if (filters[i].indexOf(attributes[i][k]) == -1) {
                        var option = document.createElement("option");
                        option.value = attributes[i][k];
                        option.text = attributes[i][k];
                        select.appendChild(option);
                    }
                }
            } else {
                for (k = 0; k < filters[i].length; k++) {
                    
                    var option = document.createElement("option");
                    option.value = filters[i][k];
                    option.text = filters[i][k];
                    select.appendChild(option);
                }
            }
            
            select.onchange = function (e) {
                console.log(e)
                var s = this.options[this.selectedIndex].value;
                var ii = Number(this.id[this.id.length - 1]);
                var jj = Number(this.id[this.id.length - 2]);
                var ie = filters[ii].indexOf(s);
                if (ie == -1) {
                    if (jj == 0)
                        filters[ii].push(s)
                    else
                        filters[ii].splice(ie, 1);
                } else {
                    if (jj != 0)
                        filters[ii].splice(ie, 1);
                }
                console.log(filters);
                updateTables();
                drawFilters();
                
            }
        }
    }
}
    
function updateTables() {
    
    //Filter and Sort properties
    var min_price = Number(document.getElementById('min_price').value);
    var max_price = Number(document.getElementById('max_price').value);
    
    if (properties != null) {
        properties = properties.filter(function (el) {
          return el.price >= min_price &&
                    el.price <= max_price;
        });

        properties.sort(function(a, b){
            var precedence;
            if (b.rent_zestimate == -1) precedence = -10000;
            else (a.price/a.rent_zestimate)-(b.price/b.rent_zestimate)
            return precedence;
        });
    }
    
    if (properties != null)
            document.getElementById('table_info').innerHTML = "Ranked:" + properties.length
            
    populateTables();
}   

function populateTables() {
    $("#table-rows-table tr").remove();
    if (properties != null) {
        properties.forEach(function(d) {
            addRow("table-rows-table", d)
        })
    }
}

//Add Row
function addRow(tableID, b) {
    var table = document.getElementById(tableID);
    var rowCount = table.rows.length;
    var row = table.insertRow(rowCount);
    
    //FILTER
    for (i = 0; i < filters.length; i++) {
        if (filters[i].indexOf(b[titles[i][1]]) != -1)
            return
    }
    
    
    if (b == null)
        row.insertCell(0).innerHTML= "Nothing to Receive";
    else {
        for (i = 0; i < titles.length; i++) {
            if (attributes[i].indexOf(b[titles[i][1]]) == -1)
                attributes[i].push(b[titles[i][1]]);
            row.insertCell(i).innerHTML = b[titles[i][1]];
        }
        
    }
    row.className += " row";
    
    //Make row selectable
    row.onclick = function() {
            if (selected != null)
                selected.classList.toggle('selected');
            selected = this;
            selected.classList.toggle('selected');
            window.open(b.zillow_url);
            
        }
    
    return;
}
   
</script>
<title>REI Guru</title>
</head>
<body>
<div class="title">REI Guru</div>
<div id="message"></div>
<div id="propertiesTable">
	<div class="tableTitle">Investment Properties</div>
    <div id="table_info"> Ranked </div>
    <div class="Search Preferences">
    <form>
    Minimum Price: 
    <input id="min_price" type="text" name="min_price">
    <br>
    Maximum Price: 
    <input id="max_price" type="text" name="max_price">
    <br>
    <input type="button" value="Update Properties" id="import_button" onclick="importJson()"/>
    
    </form>
    </div>
     	
     	     <div class="table-wrapper">
                <table class="table-static-header">
                    <thead>
                        <tr id="table-titles" class="table-static-header-row">
                        </tr>
                        <tr id="table-static-header-row-add-filters" class="table-static-header-row">
                        </tr>
                        <tr id="table-static-header-row-remove-filters" class="table-static-header-row">
                        </tr>
                        
                    </thead>
                </table>
                <div class="table-rows-table-wrapper">
                    <table id="table-rows-table">
                        <tbody>	</tbody>
                    </table>
                </div>
            </div>
     </div>
</body>
</html>


<script>  
  
</script>